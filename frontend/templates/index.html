<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <title>Gestionale - Fatture & Clienti</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">

    <link rel="stylesheet" href="{{ url_for('static', filename='css/lib/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/lib/select2.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/lib/fontawesome.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
    <div class="container">
        <h1 class="mb-4 text-center text-primary">Gestione Fatture & Clienti ðŸ“ŠðŸ‘¥</h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <div class="d-flex justify-content-end mb-4">
            <button id="gotoClientsBtn" class="btn btn-secondary"><i class="fas fa-users me-2"></i>Vai a
                Clienti</button>
        </div>

        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="invoices-tab" data-bs-toggle="tab" data-bs-target="#invoices"
                    type="button" role="tab" aria-controls="invoices" aria-selected="true">
                    <i class="fas fa-list-alt me-2"></i>Fatture
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="clients-tab" data-bs-toggle="tab" data-bs-target="#clients" type="button"
                    role="tab" aria-controls="clients" aria-selected="false">
                    <i class="fas fa-users me-2"></i>Clienti
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard"
                    type="button" role="tab" aria-controls="dashboard" aria-selected="false">
                    <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                </button>
            </li>
        </ul>

        <div class="tab-content" id="mainTabContent">
            <div class="tab-pane fade show active" id="invoices" role="tabpanel" aria-labelledby="invoices-tab">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="mt-4 mb-4">Elenco Fatture Emesse</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addInvoiceModal">
                        <i class="fas fa-plus-circle me-2"></i>Aggiungi Fattura
                    </button>
                </div>

                <div class="mb-3">
                    <input type="text" id="invoiceSearch" class="form-control"
                        placeholder="Filtra per cliente, descrizione o numero fattura...">
                </div>

                {% if invoices %}
                <div class="accordion" id="invoicesAccordion">
                    {% for anno, fatture_anno in invoices.items() %}
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading-{{ anno }}">
                            <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" type="button"
                                data-bs-toggle="collapse" data-bs-target="#collapse-{{ anno }}"
                                aria-expanded="{% if loop.first %}true{% else %}false{% endif %}"
                                aria-controls="collapse-{{ anno }}">
                                Anno {{ anno }} ({{ fatture_anno | length }} fatture)
                            </button>
                        </h2>
                        <div id="collapse-{{ anno }}"
                            class="accordion-collapse collapse {% if loop.first %}show{% endif %}"
                            aria-labelledby="heading-{{ anno }}" data-bs-parent="#invoicesAccordion">
                            <div class="accordion-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover table-bordered mb-0">
                                        <thead>
                                            <tr>
                                                <th>Numero</th>
                                                <th>Data Fattura</th>
                                                <th>Data Pagamento</th>
                                                <th>Metodo</th>
                                                <th>Cliente</th>
                                                <th>Descrizione</th>
                                                <th>Totale</th>
                                                <th>Inviata SNS</th>
                                                <th>Azioni</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for invoice in fatture_anno %}
                                            <tr>
                                                <td>{{ invoice.numero_fattura }}</td>
                                                <td>{{ invoice.data_fattura | to_italian_date }}</td>
                                                <td>{{ invoice.data_pagamento | to_italian_date if
                                                    invoice.data_pagamento else 'N/D' }}</td>
                                                <td>
                                                    {% if invoice.metodo_pagamento == 'Carta di credito/debito' %}
                                                    <i class="fas fa-credit-card text-primary"
                                                        title="Carta di credito/debito"></i>
                                                    {% elif invoice.metodo_pagamento == 'Bonifico' %}
                                                    <i class="fas fa-university text-success" title="Bonifico"></i>
                                                    {% elif invoice.metodo_pagamento == 'Contanti' %}
                                                    <i class="fas fa-money-bill-wave text-warning" title="Contanti"></i>
                                                    {% else %}
                                                    <span class="text-muted">N/D</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ invoice.cliente }}</td>
                                                <td>{{ invoice.descrizione }}</td>
                                                <td>â‚¬{{ invoice.totale }}</td>
                                                <td class="text-center">
                                                    {% if invoice.inviata_sns %}
                                                    <span class="text-success" title="SÃ¬">&#10004;</span>
                                                    {% else %}
                                                    <span class="text-danger" title="No">&#10006;</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <a href="{{ url_for('download_invoice', invoice_id=invoice.id) }}"
                                                        class="btn btn-success btn-sm" title="Scarica fattura"><i
                                                            class="fas fa-download"></i></a>
                                                    <button type="button" class="btn btn-primary btn-sm"
                                                        onclick="openEditInvoiceModal({{ invoice.id }})"
                                                        title="Modifica"><i class="fas fa-edit"></i></button>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="alert alert-info mt-4">Nessuna fattura emessa.</p>
                {% endif %}
            </div>

            <div class="tab-pane fade" id="clients" role="tabpanel" aria-labelledby="clients-tab">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="mt-4 mb-4">Gestione Clienti</h2>
                    <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#addClientModal"><i
                            class="fas fa-user-plus me-2"></i>Aggiungi Cliente</button>
                </div>

                <div class="mb-3">
                    <label for="clientSearch" class="form-label">Cerca Cliente</label>
                    <input type="text" class="form-control" id="clientSearch"
                        placeholder="Digita nome, cognome o codice fiscale...">
                </div>

                <div id="clientListContainer">
                    <ul class="list-group mb-4" id="clientList">
                        {% for client in clients %}
                        <li class="list-group-item d-flex justify-content-between align-items-center client-item">
                            <div>
                                <strong>{{ client.nome }} {{ client.cognome }}</strong> - CF: {{ client.codice_fiscale
                                }} -
                                Indirizzo: {{ client.indirizzo or 'N/D' }}, {{ client.citta or 'N/D' }} ({{ client.cap
                                or 'N/D' }})
                            </div>
                            <div>
                                <button type="button" class="btn btn-warning btn-sm me-2"
                                    onclick="openEditClientModal({{ client.id }})">Modifica</button>
                                <button type="button" class="btn btn-danger btn-sm"
                                    onclick="confirmDeleteClient({{ client.id }})" disabled>Elimina</button>
                            </div>
                        </li>
                        {% else %}
                        <li class="list-group-item no-clients">Nessun cliente registrato.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <div class="tab-pane fade" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                <div class="d-flex justify-content-between align-items-center mt-4 mb-4">
                    <h2 class="mb-0">Panoramica e Report</h2>
                    <div class="d-flex align-items-center">
                        <label for="yearSelector" class="form-label me-2 mb-0">Anno:</label>
                        <select class="form-select" id="yearSelector" style="width: 150px;">
                            <option value="">Tutti gli anni</option>
                            <!-- VerrÃ  popolato dinamicamente via JavaScript -->
                        </select>
                    </div>
                </div>

                <div class="row" id="dashboard-stats">
                    <!-- Le statistiche verranno caricate qui dinamicamente -->
                </div>

                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0" id="chartPerMeseTitle">Totale Fatturato per Mese</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="chartPerMese"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">Fatture per Cliente</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="chartPerCliente"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="addClientModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <form id="addClientForm" class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Aggiungi un nuovo Cliente</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                aria-label="Chiudi"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="nome" class="form-label">Nome</label>
                                <input type="text" class="form-control" id="nome" name="nome" required>
                            </div>
                            <div class="mb-3">
                                <label for="cognome" class="form-label">Cognome</label>
                                <input type="text" class="form-control" id="cognome" name="cognome" required>
                            </div>
                            <div class="mb-3">
                                <label for="codice_fiscale" class="form-label">Codice Fiscale</label>
                                <input type="text" class="form-control" id="codice_fiscale" name="codice_fiscale"
                                    required>
                            </div>
                            <div class="mb-3">
                                <label for="indirizzo" class="form-label">Indirizzo</label>
                                <input type="text" class="form-control" id="indirizzo" name="indirizzo">
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="citta" class="form-label">CittÃ </label>
                                    <input type="text" class="form-control" id="citta" name="citta">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="cap" class="form-label">CAP</label>
                                    <input type="text" class="form-control" id="cap" name="cap">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Aggiungi Cliente</button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="modal fade" id="editClientModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <form id="editClientForm" class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Modifica Cliente</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                aria-label="Chiudi"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="edit-client-id" name="id">
                            <div class="mb-3">
                                <label for="edit-nome" class="form-label">Nome</label>
                                <input type="text" class="form-control" id="edit-nome" name="nome" required>
                            </div>
                            <div class="mb-3">
                                <label for="edit-cognome" class="form-label">Cognome</label>
                                <input type="text" class="form-control" id="edit-cognome" name="cognome" required>
                            </div>
                            <div class="mb-3">
                                <label for="edit-codice_fiscale" class="form-label">Codice Fiscale</label>
                                <input type="text" class="form-control" id="edit-codice_fiscale" name="codice_fiscale"
                                    required>
                            </div>
                            <div class="mb-3">
                                <label for="edit-indirizzo" class="form-label">Indirizzo</label>
                                <input type="text" class="form-control" id="edit-indirizzo" name="indirizzo">
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="edit-citta" class="form-label">CittÃ </label>
                                    <input type="text" class="form-control" id="edit-citta" name="citta">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="edit-cap" class="form-label">CAP</label>
                                    <input type="text" class="form-control" id="edit-cap" name="cap">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                            <button type="submit" class="btn btn-primary">Salva Modifiche</button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="modal fade" id="confirmDeleteClientModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Conferma eliminazione</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                aria-label="Chiudi"></button>
                        </div>
                        <div class="modal-body">
                            Sei sicuro di voler eliminare questo cliente?
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                            <button type="button" id="confirmDeleteClientBtn" class="btn btn-danger">Elimina</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="addInvoiceModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <form id="addInvoiceForm" class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">Aggiungi una nuova Fattura</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="cliente_id" class="form-label">Seleziona Cliente</label>
                                    <select class="form-control" id="cliente_id" name="cliente_id" required>
                                        <option value="">Seleziona...</option>
                                        {% for client in clients %}
                                        <option value="{{ client.id }}">{{ client.nome }} {{ client.cognome }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="data_fattura" class="form-label">Data Fattura</label>
                                    <input type="date" class="form-control" id="data_fattura" name="data_fattura"
                                        value="{{ now.strftime('%Y-%m-%d') }}" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="numero_sedute" class="form-label">Numero di Sedute</label>
                                    <input type="number" class="form-control" id="numero_sedute" name="numero_sedute"
                                        value="1" min="1" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="metodo_pagamento" class="form-label">Metodo Pagamento</label>
                                    <select class="form-control" id="metodo_pagamento" name="metodo_pagamento" required>
                                        <option value="Carta di credito/debito">Carta di credito/debito</option>
                                        <option value="Bonifico">Bonifico</option>
                                        <option value="Contanti">Contanti</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="data_pagamento" class="form-label">Data Pagamento (opzionale)</label>
                                    <input type="date" class="form-control" id="data_pagamento" name="data_pagamento"
                                        value="{{ now.strftime('%Y-%m-%d') }}">
                                </div>
                                <div class="col-md-4 d-flex align-items-end mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="inviata_sns"
                                            name="inviata_sns">
                                        <label class="form-check-label" for="inviata_sns">Inviata a Sistema
                                            Sanitario</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary"><i
                                    class="fas fa-plus-circle me-2"></i>Aggiungi
                                Fattura</button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="modal fade" id="editInvoiceModal" tabindex="-1" aria-labelledby="editInvoiceModalLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title" id="editInvoiceModalLabel">Modifica Fattura</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editInvoiceForm">
                                <input type="hidden" id="edit-invoice-id">
                                <div class="mb-3">
                                    <label for="edit-cliente_id" class="form-label">Seleziona Cliente</label>
                                    <select class="form-control" id="edit-cliente_id" name="cliente_id" required>
                                        {% for client in clients %}
                                        <option value="{{ client.id }}">{{ client.nome }} {{ client.cognome }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="edit-data_fattura" class="form-label">Data Fattura</label>
                                    <input type="date" class="form-control" id="edit-data_fattura" name="data_fattura"
                                        required>
                                </div>
                                <div class="mb-3">
                                    <label for="edit-numero_sedute" class="form-label">Numero di Sedute</label>
                                    <input type="number" class="form-control" id="edit-numero_sedute"
                                        name="numero_sedute" min="1" required>
                                </div>
                                <div class="mb-3">
                                    <label for="edit-metodo_pagamento" class="form-label">Metodo Pagamento</label>
                                    <select class="form-control" id="edit-metodo_pagamento" name="metodo_pagamento"
                                        required>
                                        <option value="Carta di credito/debito">Carta di credito/debito</option>
                                        <option value="Bonifico">Bonifico</option>
                                        <option value="Contanti">Contanti</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="edit-data_pagamento" class="form-label">Data Pagamento</label>
                                    <input type="date" class="form-control" id="edit-data_pagamento"
                                        name="data_pagamento">
                                </div>
                                <div class="mb-3 form-check">
                                    <input class="form-check-input" type="checkbox" id="edit-inviata-sns"
                                        name="inviata_sns">
                                    <label class="form-check-label" for="edit-inviata-sns">Inviata a Sistema
                                        Sanitario</label>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary"
                                        data-bs-dismiss="modal">Annulla</button>
                                    <button type="submit" class="btn btn-primary">Salva Modifiche</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <script src="{{ url_for('static', filename='js/lib/jquery.min.js') }}"></script>
        <script src="{{ url_for('static', filename='js/lib/bootstrap.bundle.min.js') }}"></script>
        <script src="{{ url_for('static', filename='js/lib/select2.min.js') }}"></script>
        <script src="{{ url_for('static', filename='js/lib/chart.min.js') }}"></script>
        <script type="module" src="{{ url_for('static', filename='js/clienti.js') }}"></script>
        <script type="module" src="{{ url_for('static', filename='js/fatture.js') }}"></script>
        <script type="module" src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
        <script type="module" src="{{ url_for('static', filename='js/main.js') }}"></script>

</body>

</html>