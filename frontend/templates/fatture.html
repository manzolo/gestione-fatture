<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <title>Gestione Fatture</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }

        .container {
            max-width: 1200px;
        }

        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .stat-card {
            background-color: #fff;
            border-left: 5px solid #007bff;
        }

        .stat-icon {
            font-size: 2.5rem;
            color: #007bff;
        }

        .nav-tabs .nav-link.active {
            font-weight: bold;
            color: #007bff !important;
            border-color: #dee2e6 #dee2e6 #fff;
        }

        .tab-content {
            padding: 20px 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="mb-4 text-center text-primary">Gestione Fatture ðŸ“Š</h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <div class="d-flex justify-content-end mb-4">
            <a href="/clienti" class="btn btn-secondary"><i class="fas fa-users me-2"></i>Vai a Clienti</a>
        </div>

        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="invoices-tab" data-bs-toggle="tab" data-bs-target="#invoices"
                    type="button" role="tab" aria-controls="invoices" aria-selected="true">
                    <i class="fas fa-list-alt me-2"></i>Fatture
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard"
                    type="button" role="tab" aria-controls="dashboard" aria-selected="false">
                    <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="add-invoice-tab" data-bs-toggle="tab" data-bs-target="#add-invoice"
                    type="button" role="tab" aria-controls="add-invoice" aria-selected="false">
                    <i class="fas fa-plus-circle me-2"></i>Aggiungi Fattura
                </button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="invoices" role="tabpanel" aria-labelledby="invoices-tab">
                <h2 class="mt-4 mb-4">Elenco Fatture Emesse</h2>
                <div class="mb-3">
                    <input type="text" id="invoiceSearch" class="form-control"
                        placeholder="Filtra per cliente, descrizione o numero fattura...">
                </div>

                {% if invoices %}
                <div class="accordion" id="invoicesAccordion">
                    {% for anno, fatture_anno in invoices.items() %}
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading-{{ anno }}">
                            <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" type="button"
                                data-bs-toggle="collapse" data-bs-target="#collapse-{{ anno }}"
                                aria-expanded="{% if loop.first %}true{% else %}false{% endif %}"
                                aria-controls="collapse-{{ anno }}">
                                Anno {{ anno }} ({{ fatture_anno | length }} fatture)
                            </button>
                        </h2>
                        <div id="collapse-{{ anno }}"
                            class="accordion-collapse collapse {% if loop.first %}show{% endif %}"
                            aria-labelledby="heading-{{ anno }}" data-bs-parent="#invoicesAccordion">
                            <div class="accordion-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover table-bordered mb-0">
                                        <thead>
                                            <tr>
                                                <th>Numero</th>
                                                <th>Data Fattura</th>
                                                <th>Data Pagamento</th>
                                                <th>Metodo</th>
                                                <th>Cliente</th>
                                                <th>Descrizione</th>
                                                <th>Totale</th>
                                                <th>Inviata SNS</th>
                                                <th>Azioni</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for invoice in fatture_anno %}
                                            <tr>
                                                <td>{{ invoice.numero_fattura }}</td>
                                                <td>{{ invoice.data_fattura | to_italian_date }}</td>
                                                <td>{{ invoice.data_pagamento | to_italian_date if invoice.data_pagamento else
                                                    'N/D' }}</td>
                                                <td>{{ invoice.metodo_pagamento if invoice.metodo_pagamento else 'N/D' }}</td>
                                                <td>{{ invoice.cliente }}</td>
                                                <td>{{ invoice.descrizione }}</td>
                                                <td>â‚¬{{ invoice.totale }}</td>
                                                <td class="text-center">
                                                    {% if invoice.inviata_sns %}
                                                    <span class="text-success" title="SÃ¬">&#10004;</span>
                                                    {% else %}
                                                    <span class="text-danger" title="No">&#10006;</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <a href="{{ url_for('download_invoice', invoice_id=invoice.id) }}"
                                                        class="btn btn-success btn-sm" title="Scarica"><i
                                                            class="fas fa-download"></i></a>
                                                    <button type="button" class="btn btn-primary btn-sm"
                                                        onclick="openEditModal({{ invoice.id }})" title="Modifica"><i
                                                            class="fas fa-edit"></i></button>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="alert alert-info mt-4">Nessuna fattura emessa.</p>
                {% endif %}
            </div>

            <div class="tab-pane fade" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                <h2 class="mt-4 mb-4">Panoramica e Report</h2>
                <div class="row" id="dashboard-stats">
                </div>
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">Totale Fatturato per Mese</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="chartPerMese"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">Fatture per Cliente</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="chartPerCliente"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="add-invoice" role="tabpanel" aria-labelledby="add-invoice-tab">
                <h2 class="mt-4 mb-4">Aggiungi una nuova Fattura</h2>
                <div class="card mb-4">
                    <div class="card-body">
                        <form id="addInvoiceForm">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="cliente_id" class="form-label">Seleziona Cliente</label>
                                    <select class="form-control" id="cliente_id" name="cliente_id" required>
                                        <option value="">Seleziona...</option>
                                        {% for client in clients %}
                                        <option value="{{ client.id }}">{{ client.nome }} {{ client.cognome }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="data_fattura" class="form-label">Data Fattura</label>
                                    <input type="date" class="form-control" id="data_fattura" name="data_fattura"
                                        value="{{ now.strftime('%Y-%m-%d') }}" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="numero_sedute" class="form-label">Numero di Sedute</label>
                                    <input type="number" class="form-control" id="numero_sedute" name="numero_sedute"
                                        value="1" min="1" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="metodo_pagamento" class="form-label">Metodo Pagamento</label>
                                    <select class="form-control" id="metodo_pagamento" name="metodo_pagamento"
                                        required>
                                        <option value="Bonifico">Bonifico</option>
                                        <option value="Carta di credito/debito">Carta di credito/debito</option>
                                        <option value="Contanti">Contanti</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="data_pagamento" class="form-label">Data Pagamento (opzionale)</label>
                                    <input type="date" class="form-control" id="data_pagamento" name="data_pagamento"
                                        value="{{ now.strftime('%Y-%m-%d') }}">
                                </div>
                                <div class="col-md-4 d-flex align-items-end mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="inviata_sns"
                                            name="inviata_sns">
                                        <label class="form-check-label" for="inviata_sns">Inviata a Sistema
                                            Sanitario</label>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary"><i
                                    class="fas fa-plus-circle me-2"></i>Aggiungi Fattura</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="editInvoiceModal" tabindex="-1" aria-labelledby="editInvoiceModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="editInvoiceModalLabel">Modifica Fattura</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editInvoiceForm">
                        <input type="hidden" id="edit-invoice-id">
                        <div class="mb-3">
                            <label for="edit-cliente_id" class="form-label">Seleziona Cliente</label>
                            <select class="form-control" id="edit-cliente_id" name="cliente_id" required>
                                {% for client in clients %}
                                <option value="{{ client.id }}">{{ client.nome }} {{ client.cognome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="edit-data_fattura" class="form-label">Data Fattura</label>
                            <input type="date" class="form-control" id="edit-data_fattura" name="data_fattura" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-numero_sedute" class="form-label">Numero di Sedute</label>
                            <input type="number" class="form-control" id="edit-numero_sedute" name="numero_sedute"
                                min="1" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-metodo_pagamento" class="form-label">Metodo Pagamento</label>
                            <select class="form-control" id="edit-metodo_pagamento" name="metodo_pagamento" required>
                                <option value="Bonifico">Bonifico</option>
                                <option value="Carta di credito/debito">Carta di credito/debito</option>
                                <option value="Contanti">Contanti</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="edit-data_pagamento" class="form-label">Data Pagamento</label>
                            <input type="date" class="form-control" id="edit-data_pagamento" name="data_pagamento">
                        </div>
                        <div class="mb-3 form-check">
                            <input class="form-check-input" type="checkbox" id="edit-inviata-sns" name="inviata_sns">
                            <label class="form-check-label" for="edit-inviata-sns">Inviata a Sistema Sanitario</label>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                            <button type="submit" class="btn btn-primary">Salva Modifiche</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Inizializzazione di Select2
        $(document).ready(function () {
            $('#cliente_id').select2({
                placeholder: "Seleziona un cliente",
                allowClear: true
            });
            $('#edit-cliente_id').select2({
                dropdownParent: $('#editInvoiceModal'),
                placeholder: "Seleziona un cliente",
                allowClear: true
            });
        });

        // Funzione per inviare i dati del form di aggiunta
        document.getElementById('addInvoiceForm').addEventListener('submit', function (event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            data.inviata_sns = document.getElementById('inviata_sns').checked;

            fetch('/api/invoices', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) throw new Error('Errore durante l\'aggiunta della fattura.');
                window.location.reload();
            })
            .catch(error => {
                console.error('Errore:', error);
                alert('Si Ã¨ verificato un errore durante l\'aggiunta della fattura.');
            });
        });

        // Funzione per aprire il modal di modifica
        function openEditModal(invoiceId) {
            fetch(`/api/invoices/${invoiceId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('edit-invoice-id').value = data.id;
                    $('#edit-cliente_id').val(data.cliente_id).trigger('change');
                    document.getElementById('edit-data_fattura').value = data.data_fattura;
                    document.getElementById('edit-numero_sedute').value = data.numero_sedute;
                    document.getElementById('edit-metodo_pagamento').value = data.metodo_pagamento;
                    document.getElementById('edit-data_pagamento').value = data.data_pagamento || '';
                    document.getElementById('edit-inviata-sns').checked = data.inviata_sns;

                    var editModal = new bootstrap.Modal(document.getElementById('editInvoiceModal'));
                    editModal.show();
                })
                .catch(error => {
                    console.error('Errore nel caricamento dei dati per la modifica:', error);
                    alert('Impossibile caricare i dati della fattura per la modifica.');
                });
        }

        // Funzione per inviare i dati del form di modifica
        document.getElementById('editInvoiceForm').addEventListener('submit', function (event) {
            event.preventDefault();
            const invoiceId = document.getElementById('edit-invoice-id').value;
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            
            // Logica corretta e semplificata per il checkbox
            data.inviata_sns = document.getElementById('edit-inviata-sns').checked;

            fetch(`/api/invoices/${invoiceId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) throw new Error('Errore durante la modifica della fattura.');
                var editModal = bootstrap.Modal.getInstance(document.getElementById('editInvoiceModal'));
                editModal.hide();
                window.location.reload();
            })
            .catch(error => {
                console.error('Errore:', error);
                alert('Si Ã¨ verificato un errore durante la modifica della fattura.');
            });
        });

        // Funzione per filtrare la tabella delle fatture
        document.getElementById('invoiceSearch').addEventListener('keyup', function () {
            const searchText = this.value.toLowerCase();
            const accordionItems = document.querySelectorAll('.accordion-item');
            accordionItems.forEach(item => {
                const rows = item.querySelectorAll('tbody tr');
                let cardHasVisibleRows = false;
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    let found = false;
                    for (let j = 0; j < cells.length; j++) {
                        const cellText = cells[j].textContent || cells[j].innerText;
                        if (cellText.toLowerCase().indexOf(searchText) > -1) {
                            found = true;
                            break;
                        }
                    }
                    if (found) {
                        row.style.display = "";
                        cardHasVisibleRows = true;
                    } else {
                        row.style.display = "none";
                    }
                });
                if (searchText === '') {
                    item.style.display = "";
                } else if (cardHasVisibleRows) {
                    item.style.display = "";
                    new bootstrap.Collapse(item.querySelector('.accordion-collapse')).show();
                } else {
                    item.style.display = "none";
                }
            });
        });

        // Caricamento e rendering dei report
        fetch('/api/invoices/stats')
            .then(res => {
                if (!res.ok) throw new Error('Errore nel caricamento delle statistiche.');
                return res.json();
            })
            .then(data => {
                // Statistiche di riepilogo
                const statsHtml = `
                    <div class="col-md-4">
                        <div class="card text-center p-3 stat-card">
                            <div class="d-flex justify-content-center align-items-center mb-2">
                                <i class="fas fa-euro-sign stat-icon me-3"></i>
                                <div>
                                    <h5 class="mb-0 text-secondary">Totale Annuo</h5>
                                    <h3 class="fw-bold text-primary">â‚¬${data.totale_annuo.toFixed(2).replace('.', ',')}</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center p-3 stat-card">
                            <div class="d-flex justify-content-center align-items-center mb-2">
                                <i class="fas fa-file-invoice stat-icon me-3"></i>
                                <div>
                                    <h5 class="mb-0 text-secondary">Fatture Emesse</h5>
                                    <h3 class="fw-bold text-primary">${data.totale_fatture}</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center p-3 stat-card">
                            <div class="d-flex justify-content-center align-items-center mb-2">
                                <i class="fas fa-users stat-icon me-3"></i>
                                <div>
                                    <h5 class="mb-0 text-secondary">Clienti con Fatture</h5>
                                    <h3 class="fw-bold text-primary">${data.clienti_con_fatture}</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('dashboard-stats').innerHTML = statsHtml;

                // === GRAFICO PER MESE ===
                const mesi = data.per_mese.map(item => item.mese);
                const totaliMese = data.per_mese.map(item => item.totale);
                const conteggiMese = data.per_mese.map(item => item.conteggio);
                
                const ctxMese = document.getElementById('chartPerMese').getContext('2d');
                new Chart(ctxMese, {
                    type: 'bar',
                    data: {
                        labels: mesi,
                        datasets: [
                            {
                                label: 'Totale Fatturato (â‚¬)',
                                data: totaliMese,
                                backgroundColor: 'rgba(75, 192, 192, 0.8)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Numero di Fatture',
                                data: conteggiMese,
                                backgroundColor: 'rgba(153, 102, 255, 0.8)',
                                borderColor: 'rgba(153, 102, 255, 1)',
                                type: 'line',
                                fill: false,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: { mode: 'index', intersect: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Totale (â‚¬)' }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                grid: { drawOnChartArea: false },
                                title: { display: true, text: 'Numero di Fatture' }
                            }
                        }
                    }
                });

                // === GRAFICO PER CLIENTE ===
                const clienti = data.per_cliente.map(item => item.cliente);
                const conteggiCliente = data.per_cliente.map(item => item.conteggio);
                const totaliCliente = data.per_cliente.map(item => item.totale);

                const ctxCliente = document.getElementById('chartPerCliente').getContext('2d');
                new Chart(ctxCliente, {
                    type: 'pie',
                    data: {
                        labels: clienti,
                        datasets: [{
                            label: 'Totale Fatturato per Cliente',
                            data: totaliCliente,
                            backgroundColor: clienti.map((_, i) =>
                                `hsl(${i * 50 % 360}, 70%, 60%)`
                            ),
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += `â‚¬${context.parsed.toFixed(2).replace('.', ',')} (${conteggiCliente[context.dataIndex]} fatture)`;
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            })
            .catch(err => {
                console.error('Errore nel caricamento dei report:', err);
                const dashboard = document.getElementById('dashboard-stats');
                if (dashboard) dashboard.innerHTML = '<div class="col-12"><p class="alert alert-danger">Errore nel caricamento dei report. Assicurati che il backend sia attivo.</p></div>';
            });
    </script>
</body>
</html>